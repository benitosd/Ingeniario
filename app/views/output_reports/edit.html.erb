<div class="container mt-4">
 <div class="card">
   <div class="card-header">
     <h3 class="card-title">Editar Informe de Salida</h3>
   </div>
   <div class="card-body" data-controller="qr-scanner nested-form">
     <%= form_with(model: @output_report, local: true) do |f| %>
       <% if @output_report.errors.any? %>
         <div class="alert alert-danger">
           <h4><%= pluralize(@output_report.errors.count, "error") %> impidieron guardar este informe:</h4>
           <ul>
             <% @output_report.errors.full_messages.each do |msg| %>
               <li><%= msg %></li>
             <% end %>
           </ul>
         </div>
       <% end %>

       <div class="row">
         <div class="col-md-6">
           <div class="mb-3">
             <%= f.label :user_id, "Usuario", class: "form-label" %>
             <%= f.collection_select :user_id, User.all, :id, :code, {}, class: "form-select" %>
           </div>

           <div class="mb-3">
             <%= f.label :date, "Fecha", class: "form-label" %>
             <%= f.date_field :date, class: "form-control" %>
           </div>

           <div class="mb-3">
             <%= f.label :reason, "Motivo", class: "form-label" %>
             <%= f.text_area :reason, class: "form-control", rows: 3 %>
           </div>
         </div>

         <div class="col-md-6">
           <!-- QR Scanner -->
           <div class="card mb-3">
             <div class="card-header">
               <h5 class="card-title mb-0">Escanear QR</h5>
             </div>
             <div class="card-body">
               <div id="reader"></div>
               <div data-qr-scanner-target="result"></div>
             </div>
           </div>
         </div>
       </div>

       <!-- Tabla de Stocks -->
       <div class="table-responsive mt-4">
         <table class="table">
           <thead>
             <tr>
               <th>Referencia</th>
               <th>Item</th>
               <th>Fecha de Devolución</th>
               <th>Notas</th>
               <th></th>
             </tr>
           </thead>
           <tbody data-nested-form-target="container" data-qr-scanner-target="stocksContainer">
             <%= f.fields_for :output_report_stocks do |stock_form| %>
               <%= render 'output_report_stock_fields', f: stock_form %>
             <% end %>
           </tbody>
         </table>

         <div class="mb-3">
           <button type="button" class="btn btn-secondary" data-action="nested-form#add">
             Añadir Stock
           </button>
         </div>
       </div>

       <div class="d-grid gap-2 d-md-flex justify-content-md-end">
         <%= link_to 'Cancelar', output_report_path(@output_report), class: 'btn btn-secondary me-md-2' %>
         <%= f.submit 'Guardar Cambios', class: 'btn btn-primary' %>
       </div>
     <% end %>

     <!-- Template para nuevos stocks -->
     <template data-nested-form-target="template">
       <tr class="nested-fields">
         <td>
           <select name="output_report[output_report_stocks_attributes][NEW_RECORD][stock_id]" class="form-select">
             <option value="">Seleccione un stock</option>
             <% @available_stocks.each do |stock| %>
               <option value="<%= stock.id %>"><%= stock.reference %></option>
             <% end %>
           </select>
         </td>
         <td class="stock-name"></td>
         <td>
           <input type="date" 
                  name="output_report[output_report_stocks_attributes][NEW_RECORD][return_date]" 
                  class="form-control">
         </td>
         <td>
           <textarea name="output_report[output_report_stocks_attributes][NEW_RECORD][notes]" 
                     class="form-control" 
                     rows="2"></textarea>
         </td>
         <td>
           <button type="button" 
                   class="btn btn-danger btn-sm"
                   data-action="nested-form#remove">
             <i class="fas fa-trash"></i>
           </button>
         </td>
       </tr>
     </template>
   </div>
 </div>
</div>